{"version":3,"file":"file-uploader.service.js","sourceRoot":"","sources":["file-uploader.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable, EventEmitter } from '@angular/core';\r\n\r\nclass UploadedFile {\r\n  id: string;\r\n  status: number;\r\n  statusText: string;\r\n  progress: Object;\r\n  originalName: string;\r\n  size: number;\r\n  response: string;\r\n  done: boolean;\r\n  error: boolean;\r\n  abort: boolean;\r\n\r\n  constructor(id: string, originalName: string, size: number) {\r\n    this.id = id;\r\n    this.originalName = originalName;\r\n    this.size = size;\r\n    this.progress = {\r\n      loaded: 0,\r\n      total: 0,\r\n      percent: 0\r\n    };\r\n    this.done = false;\r\n    this.error = false;\r\n    this.abort = false;\r\n  }\r\n\r\n  setProgres(progress: Object): void {\r\n    this.progress = progress;\r\n  }\r\n\r\n  setError(): void {\r\n    this.error = true;\r\n    this.done = true;\r\n  }\r\n\r\n  setAbort(): void {\r\n    this.abort = true;\r\n    this.done = true;\r\n  }\r\n\r\n  onFinished(status: number, statusText: string, response: string): void {\r\n    this.status = status;\r\n    this.statusText = statusText;\r\n    this.response = response;\r\n    this.done = true;\r\n  }\r\n}\r\n\r\n@Injectable()\r\nexport class FileUploaderService {\r\n\r\n  url: string;\r\n    cors: boolean = false;\r\n    withCredentials: boolean = false;\r\n    multiple: boolean = false;\r\n    maxUploads: number = 3;\r\n    allowedExtensions: string[] = [];\r\n    maxSize: boolean = false;\r\n    data: Object = {};\r\n    noParams: boolean = true;\r\n    autoUpload: boolean = true;\r\n    multipart: boolean = true;\r\n    method: string = 'POST';\r\n    debug: boolean = false;\r\n    customHeaders: Object = {};\r\n    encodeHeaders: boolean = true;\r\n    authTokenPrefix: string = \"Bearer\";\r\n    authToken: string = undefined;\r\n    fieldName: string = \"file\";\r\n\r\n    _queue: any[] = [];\r\n    _emitter: EventEmitter<any> = new EventEmitter(true);\r\n\r\n    setOptions(options: any): void {\r\n\r\n      this.url = options.url != null ? options.url : this.url;\r\n      this.cors = options.cors != null ? options.cors : this.cors;\r\n      this.withCredentials = options.withCredentials != null ? options.withCredentials : this.withCredentials;\r\n      this.multiple = options.multiple != null ? options.multiple : this.multiple;\r\n      this.maxUploads = options.maxUploads != null ? options.maxUploads : this.maxUploads;\r\n      this.allowedExtensions = options.allowedExtensions != null ? options.allowedExtensions : this.allowedExtensions;\r\n      this.maxSize = options.maxSize != null ? options.maxSize : this.maxSize;\r\n      this.data = options.data != null ? options.data : this.data;\r\n      this.noParams = options.noParams != null ? options.noParams : this.noParams;\r\n      this.autoUpload = options.autoUpload != null ? options.autoUpload : this.autoUpload;\r\n      this.multipart = options.multipart != null ? options.multipart : this.multipart;\r\n      this.method = options.method != null ? options.method : this.method;\r\n      this.debug = options.debug != null ? options.debug : this.debug;\r\n      this.customHeaders = options.customHeaders != null ? options.customHeaders : this.customHeaders;\r\n      this.encodeHeaders = options.encodeHeaders != null ? options.encodeHeaders : this.encodeHeaders;\r\n      this.authTokenPrefix = options.authTokenPrefix != null ? options.authTokenPrefix : this.authTokenPrefix;\r\n      this.authToken = options.authToken != null ? options.authToken : this.authToken;\r\n      this.fieldName = options.fieldName != null ? options.fieldName : this.fieldName;\r\n\r\n      if (!this.multiple) {\r\n        this.maxUploads = 1;\r\n      }\r\n    }\r\n\r\n    uploadFilesInQueue(): void {\r\n      let newFiles = this._queue.filter((f) => { return !f.uploading; });\r\n      newFiles.forEach((f) => {\r\n        this.uploadFile(f);\r\n      });\r\n    };\r\n\r\n    uploadFile(file: any): void {\r\n      let xhr = new XMLHttpRequest();\r\n      let form = new FormData();\r\n      form.append(this.fieldName, file, file.name);\r\n\r\n      let uploadingFile = new UploadedFile(\r\n          this.generateRandomIndex(),\r\n          file.name,\r\n          file.size\r\n      );\r\n\r\n      let queueIndex = this._queue.indexOf(file);\r\n\r\n      xhr.upload.onprogress = (e) => {\r\n        if (e.lengthComputable) {\r\n          let percent = Math.round(e.loaded / e.total * 100);\r\n          uploadingFile.setProgres({\r\n            total: e.total,\r\n            loaded: e.loaded,\r\n            percent: percent\r\n          });\r\n\r\n          this._emitter.emit(uploadingFile);\r\n        }\r\n      }\r\n\r\n      xhr.upload.onabort = (e) => {\r\n        uploadingFile.setAbort();\r\n        this._emitter.emit(uploadingFile);\r\n      }\r\n\r\n      xhr.upload.onerror = (e) => {\r\n        uploadingFile.setError();\r\n        this._emitter.emit(uploadingFile);\r\n      }\r\n\r\n      xhr.onreadystatechange = () => {\r\n        if (xhr.readyState === XMLHttpRequest.DONE) {\r\n          uploadingFile.onFinished(\r\n              xhr.status,\r\n              xhr.statusText,\r\n              xhr.response\r\n          );\r\n          this.removeFileFromQueue(queueIndex);\r\n          this._emitter.emit(uploadingFile);\r\n        }\r\n      }\r\n\r\n      xhr.open(this.method, this.url, true);\r\n      xhr.withCredentials = this.withCredentials;\r\n\r\n      if (this.customHeaders) {\r\n        Object.keys(this.customHeaders).forEach((key) => {\r\n          xhr.setRequestHeader(key, this.customHeaders[key]);\r\n        });\r\n      }\r\n\r\n      if (this.authToken) {\r\n        xhr.setRequestHeader(\"Authorization\", `${this.authTokenPrefix} ${this.authToken}`);\r\n      }\r\n\r\n      xhr.send(form);\r\n    }\r\n\r\n    addFilesToQueue(files: FileList[]): void {\r\n      for (let file of files) {\r\n        if (this.isFile(file) && !this.inQueue(file)) {\r\n          this._queue.push(file);\r\n        }\r\n      }\r\n\r\n      if (this.autoUpload) {\r\n        this.uploadFilesInQueue();\r\n      }\r\n    }\r\n\r\n    removeFileFromQueue(i: number): void {\r\n      this._queue.splice(i, 1);\r\n    }\r\n\r\n    clearQueue(): void {\r\n      this._queue = [];\r\n    }\r\n\r\n    getQueueSize(): number {\r\n      return this._queue.length;\r\n    }\r\n\r\n    inQueue(file: any): boolean {\r\n      let fileInQueue = this._queue.filter((f) => { return f === file; });\r\n      return fileInQueue.length ? true : false;\r\n    }\r\n\r\n    isFile(file: any): boolean {\r\n      return file !== null && (file instanceof Blob || (file.name && file.size));\r\n    }\r\n\r\n    log(msg: any): void {\r\n      if (!this.debug) {\r\n        return;\r\n      }\r\n      console.log('[Ng2Uploader]:', msg);\r\n    }\r\n\r\n    generateRandomIndex(): string {\r\n      return Math.random().toString(36).substring(7);\r\n    }\r\n    \r\n}\r\n"]}